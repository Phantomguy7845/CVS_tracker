<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>PT Timestamp + Location (Mint Light) v2.1</title>

  <!-- Leaflet (map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- EXIFReader (fix orientation) -->
  <script src="https://unpkg.com/exifreader@4.12.0/dist/exif-reader.min.js"></script>

  <style>
    :root{
      /* ‡∏™‡∏µ‡πÇ‡∏ó‡∏ô Mint Light */
      --bg:#f6fffb;
      --card:#ffffff;
      --line:#d7efe7;
      --text:#0f172a;
      --muted:#475569;
      --muted2:#64748b;
      --accent:#10b981;
      --soft:#eafff6;
      --warn:#f59e0b;
      --danger:#ef4444;
      --shadow: 0 10px 28px rgba(2, 6, 23, .08);
      --radius:18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans Thai", sans-serif;
      padding: 14px 14px calc(16px + env(safe-area-inset-bottom));
    }
    .wrap{ max-width: 980px; margin: 0 auto; display:grid; gap: 12px; }
    header{ display:flex; justify-content:space-between; gap: 10px; padding: 8px 4px; }
    h1{ margin:0; font-size: 18px; font-weight:900; line-height:1.2; }
    .sub{ margin-top:4px; color: var(--muted); font-size: 12px; line-height:1.35; }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 12px;
      box-shadow: var(--shadow);
    }
    .label{ font-size:12px; color:var(--muted); margin-bottom:6px; font-weight:700; }
    .muted{ color:var(--muted2); font-size:12px; line-height:1.35; }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .grid3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
    @media (max-width:820px){ .grid3{ grid-template-columns:1fr; } }
    @media (max-width:680px){ .grid2{ grid-template-columns:1fr; } }

    .field{
      width:100%;
      border-radius:14px;
      border:1px solid var(--line);
      background:#ffffff;
      color:var(--text);
      padding:12px;
      font-size:15px;
      outline:none;
    }
    .field:focus{
      border-color: rgba(16,185,129,.55);
      box-shadow: 0 0 0 4px rgba(16,185,129,.16);
    }

    .btn{
      border:1px solid var(--line);
      background:#ffffff;
      color:var(--text);
      padding:12px;
      border-radius:14px;
      font-size:15px;
      font-weight:900;
      cursor:pointer;
      min-height:46px;
      box-shadow: 0 8px 18px rgba(2,6,23,.06);
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(16,185,129,.95), rgba(16,185,129,.70));
      border-color: rgba(16,185,129,.55);
      color:#053b2a;
    }
    .btn.soft{
      background: var(--soft);
      border-color: rgba(16,185,129,.30);
      color:#064e3b;
    }
    .btn.danger{
      background: rgba(239,68,68,.12);
      border-color: rgba(239,68,68,.35);
      color:#7f1d1d;
    }
    .btn[disabled]{ opacity:.45; cursor:not-allowed; transform:none; }

    .switch{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:14px;
      background:#ffffff;
      min-height:46px;
      user-select:none;
    }
    .switch input{ width:20px; height:20px; accent-color: var(--accent); }
    .switch span{ font-size:15px; font-weight:800; color:var(--text); }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      background:#ffffff;
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      font-weight:700;
    }

    .status{
      font-size:12px;
      color:var(--muted2);
      line-height:1.35;
      white-space:pre-wrap;
    }
    .hr{ height:1px; background:var(--line); margin:10px 0; }

    canvas{
      width:100%;
      height:auto;
      border-radius:16px;
      border:1px solid var(--line);
      background:#0b0b0f;
    }
    #map{
      width:100%;
      height:320px;
      border-radius:16px;
      border:1px solid var(--line);
      overflow:hidden;
    }
    .stickyBar{
      position:sticky;
      bottom:10px;
      z-index:5;
      display:grid;
      gap:10px;
      padding:10px;
      background: rgba(246,255,251,.85);
      backdrop-filter: blur(8px);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: var(--shadow);
    }
    .modalBackdrop{
      position:fixed;
      inset:0;
      background: rgba(2,6,23,.62);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:50;
    }
    .modal{
      width:min(520px,100%);
      background:#ffffff;
      border-radius:18px;
      border:1px solid var(--line);
      box-shadow: 0 18px 50px rgba(2,6,23,.25);
      overflow:hidden;
    }
    .modalHeader{
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--line);
      background: var(--soft);
    }
    .modalHeader .title{ font-weight:900; font-size:14px; color:#064e3b; }
    .modalBody{ padding:12px; display:grid; gap:10px; }
    video{
      width:100%;
      border-radius:16px;
      border:1px solid var(--line);
      background:#000;
    }
    .mini{ font-size:12px; color:var(--muted2); margin-top:4px; line-height:1.35; }

    /* image loading indicator */
    .loadBox{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border:1px dashed rgba(16,185,129,.45);
      border-radius:14px;
      background: rgba(16,185,129,.06);
    }
    .spinner{
      width:18px; height:18px;
      border:3px solid rgba(16,185,129,.25);
      border-top-color: rgba(16,185,129,.95);
      border-radius:50%;
      animation: spin .85s linear infinite;
      display:none;
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }
    .badge{
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid var(--line);
      background:#fff;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .badge.ok{ border-color: rgba(16,185,129,.35); background: rgba(16,185,129,.08); color:#065f46; }
    .badge.wait{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10); color:#7c2d12; }
    .badge.err{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); color:#7f1d1d; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>PT Timestamp + Location (Mint Light) v2.1</h1>
        <div class="sub">‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏π‡∏õ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå Contain/Cover, ‡∏Ç‡∏ô‡∏≤‡∏î 1920√ó1440 ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏î‡∏¥‡∏°, ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ü‡∏≠‡∏ô‡∏ï‡πå ‡∏Ø‡∏•‡∏Ø</div>
      </div>
      <span class="pill">‚òÄÔ∏è ‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏î‡∏î</span>
    </header>

    <!-- 1) ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û -->
    <div class="card">
      <div class="label">1) ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</div>
      <div class="grid2">
        <button class="btn primary" id="btnOpenCamera">üì∑ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á (‡∏ñ‡πà‡∏≤‡∏¢‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á)</button>
        <div>
          <div class="label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ‡πà</div>
          <input id="fileGallery" class="field" type="file" accept="image/*">
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <span class="pill">‡πÑ‡∏°‡πà‡∏¢‡∏∑‡∏î‡∏†‡∏≤‡∏û</span>
        <span class="pill">‡πÅ‡∏Å‡πâ EXIF orientation</span>
      </div>
      <div class="hr"></div>

      <!-- image state -->
      <div class="loadBox">
        <div class="spinner" id="imgSpinner"></div>
        <div style="display:grid; gap:6px; width:100%">
          <div class="row" style="justify-content:space-between">
            <span class="badge wait" id="imgBadge">‚è≥ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ</span>
            <span class="muted" id="imgHint">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‚Äù</span>
          </div>
          <div class="status" id="imgStatus">-</div>
        </div>
      </div>
    </div>

    <!-- 2) ‡πÄ‡∏ß‡∏•‡∏≤ -->
    <div class="card">
      <div class="label">2) ‡πÄ‡∏ß‡∏•‡∏≤ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÄ‡∏≠‡∏á)</div>
      <div class="grid2">
        <label class="switch">
          <input id="useNow" type="checkbox" checked>
          <span>‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span>
        </label>
        <div>
          <div class="label">‡πÅ‡∏Å‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏≠‡∏á (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏¥‡πä‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</div>
          <input id="customTime" class="field" type="datetime-local">
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn soft" id="btnSetNow">‚è± ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button>
        <span class="status" id="timeStatus"></span>
      </div>
    </div>

    <!-- 3) Output & Fit Mode + Font -->
    <div class="card">
      <div class="label">3) Output & ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏†‡∏≤‡∏û (Contain / Cover-crop) + ‡∏ü‡∏≠‡∏ô‡∏ï‡πå</div>
      <div class="grid3">
        <div>
          <div class="label">‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å</div>
          <select id="outputMode" class="field">
            <option value="fixed" selected>1920√ó1440 (‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô)</option>
            <option value="original">‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏¥‡∏° (‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á)</option>
          </select>
          <div class="mini">‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏¥‡∏°‚Äù ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö 1920√ó1440</div>
        </div>
        <div>
          <div class="label">‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏ï‡∏¥‡∏°‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡πÄ‡∏ü‡∏£‡∏° (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏´‡∏°‡∏î 1920√ó1440)</div>
          <select id="fitMode" class="field">
            <option value="contain" selected>Contain (‡∏°‡∏µ‡∏Ç‡∏≠‡∏ö‡∏î‡∏≥‡∏ñ‡πâ‡∏≤‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á)</option>
            <option value="cover">Cover (‡πÄ‡∏ï‡πá‡∏°‡πÄ‡∏ü‡∏£‡∏° + ‡∏Ñ‡∏£‡∏≠‡∏õ)</option>
          </select>
          <div class="mini">‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡πÅ‡∏ö‡∏ö ‚Äú‡πÑ‡∏°‡πà‡∏¢‡∏∑‡∏î‡∏†‡∏≤‡∏û‚Äù</div>
        </div>
        <div>
          <div class="label">‡∏ü‡∏≠‡∏ô‡∏ï‡πå timestamp</div>
          <label class="switch" style="margin-bottom:10px">
            <input id="fontAuto" type="checkbox" checked>
            <span>Auto (‡∏™‡πÄ‡∏Å‡∏•‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ)</span>
          </label>
          <div class="grid2" style="gap:10px">
            <div>
              <div class="label">Auto scale (%)</div>
              <input id="fontScale" class="field" type="number" min="50" max="250" step="5" value="100">
            </div>
            <div>
              <div class="label">Fixed px (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î Auto)</div>
              <input id="fontPx" class="field" type="number" min="10" max="200" step="1" value="32" disabled>
            </div>
          </div>
          <div class="mini">Auto ‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î output ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏π‡∏ì‡∏î‡πâ‡∏ß‡∏¢ %</div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="status" id="outStatus">‡∏û‡∏£‡πâ‡∏≠‡∏°</div>
    </div>

    <!-- 4) ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á -->
    <div class="card">
      <div class="label">4) ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ/‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ) ‚Äî OpenStreetMap / Nominatim</div>
      <div class="grid2">
        <label class="switch">
          <input id="enableLocation" type="checkbox">
          <span>‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (Overlay)</span>
        </label>
        <div class="grid2" style="gap:10px">
          <label class="switch">
            <input id="showLatLng" type="checkbox" checked>
            <span>‡πÅ‡∏™‡∏î‡∏á Lat/Lng</span>
          </label>
          <label class="switch">
            <input id="showAddress" type="checkbox" checked>
            <span>‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</span>
          </label>
        </div>
      </div>
      <div class="grid2" style="margin-top:10px">
        <button class="btn soft" id="btnUseGPS">üìç ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (GPS)</button>
        <button class="btn" id="btnPickOnMap">üó∫Ô∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</button>
      </div>
      <div class="grid2" style="margin-top:10px">
        <div>
          <div class="label">Lat</div>
          <input id="lat" class="field" type="number" step="any" placeholder="‡πÄ‡∏ä‡πà‡∏ô 13.7563">
        </div>
        <div>
          <div class="label">Lng</div>
          <input id="lng" class="field" type="number" step="any" placeholder="‡πÄ‡∏ä‡πà‡∏ô 100.5018">
        </div>
      </div>
      <div style="margin-top:10px">
        <div class="label">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (Forward geocode)</div>
        <div class="row">
          <input id="placeQuery" class="field" placeholder="‡πÄ‡∏ä‡πà‡∏ô CentralWorld Bangkok">
          <button class="btn" id="btnSearchPlace">üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        </div>
      </div>
      <div id="mapWrap" style="display:none; margin-top:10px">
        <div class="label">‡πÅ‡∏ï‡∏∞‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î</div>
        <div id="map"></div>
        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="btnConfirmMap">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ô‡∏µ‡πâ</button>
          <button class="btn danger" id="btnCloseMap">‚úñ ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</button>
        </div>
      </div>
      <div class="hr"></div>
      <div class="status" id="locStatus">‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</div>
    </div>

    <!-- 5) Preview -->
    <div class="card">
      <div class="label">5) ‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</div>
      <canvas id="canvas" width="1920" height="1440"></canvas>
      <div class="row" style="margin-top:10px">
        <span class="status" id="renderStatus">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ render</span>
      </div>
    </div>

    <!-- Sticky actions -->
    <div class="stickyBar">
      <div class="grid2">
        <button class="btn primary" id="btnPreview" disabled>üëÅÔ∏è ‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</button>
        <button class="btn soft" id="btnDownload" disabled>‚¨áÔ∏è Download</button>
      </div>
      <div class="muted">
        ‚Ä¢ ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå: PT_YYYYMMDD_HHMMSS.jpg (‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î)<br>
        ‚Ä¢ ‡∏ñ‡πâ‡∏≤ Output = 1920√ó1440: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Contain (‡∏Ç‡∏≠‡∏ö‡∏î‡∏≥) ‡∏´‡∏£‡∏∑‡∏≠ Cover (‡∏Ñ‡∏£‡∏≠‡∏õ‡πÄ‡∏ï‡πá‡∏°‡πÄ‡∏ü‡∏£‡∏°) ‡πÑ‡∏î‡πâ
      </div>
    </div>
  </div>

  <!-- Camera Modal -->
  <div class="modalBackdrop" id="camBackdrop" aria-hidden="true">
    <div class="modal">
      <div class="modalHeader">
        <div class="title">‡∏Å‡∏•‡πâ‡∏≠‡∏á (‡∏ñ‡πà‡∏≤‡∏¢‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á)</div>
        <button class="btn danger" id="btnCloseCamera" style="min-width:auto">‡∏õ‡∏¥‡∏î</button>
      </div>
      <div class="modalBody">
        <video id="camVideo" playsinline autoplay></video>
        <div class="grid2">
          <button class="btn primary" id="btnSnap">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û</button>
          <button class="btn" id="btnSwitchCam">üîÑ ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
        </div>
        <div class="status" id="camStatus">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á...</div>
      </div>
    </div>
  </div>

<script>
(() => {
  /* ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô */
  const DEFAULT_W = 1920;
  const DEFAULT_H = 1440;

  /* Element references */
  const fileGallery  = document.getElementById('fileGallery');
  const imgSpinner   = document.getElementById('imgSpinner');
  const imgBadge     = document.getElementById('imgBadge');
  const imgHint      = document.getElementById('imgHint');
  const imgStatus    = document.getElementById('imgStatus');

  const useNow       = document.getElementById('useNow');
  const customTime   = document.getElementById('customTime');
  const btnSetNow    = document.getElementById('btnSetNow');
  const timeStatus   = document.getElementById('timeStatus');

  const outputMode   = document.getElementById('outputMode');
  const fitMode      = document.getElementById('fitMode');
  const fontAuto     = document.getElementById('fontAuto');
  const fontScale    = document.getElementById('fontScale');
  const fontPx       = document.getElementById('fontPx');
  const outStatus    = document.getElementById('outStatus');

  const enableLocation= document.getElementById('enableLocation');
  const showLatLng   = document.getElementById('showLatLng');
  const showAddress  = document.getElementById('showAddress');
  const btnUseGPS    = document.getElementById('btnUseGPS');
  const btnPickOnMap = document.getElementById('btnPickOnMap');
  const btnConfirmMap= document.getElementById('btnConfirmMap');
  const btnCloseMap  = document.getElementById('btnCloseMap');
  const mapWrap      = document.getElementById('mapWrap');
  const locStatus    = document.getElementById('locStatus');

  const latEl        = document.getElementById('lat');
  const lngEl        = document.getElementById('lng');
  const placeQuery   = document.getElementById('placeQuery');
  const btnSearchPlace = document.getElementById('btnSearchPlace');

  const btnPreview   = document.getElementById('btnPreview');
  const btnDownload  = document.getElementById('btnDownload');
  const canvas       = document.getElementById('canvas');
  const ctx          = canvas.getContext('2d');
  const renderStatus = document.getElementById('renderStatus');

  /* Camera elements */
  const btnOpenCamera  = document.getElementById('btnOpenCamera');
  const camBackdrop    = document.getElementById('camBackdrop');
  const btnCloseCamera = document.getElementById('btnCloseCamera');
  const camVideo       = document.getElementById('camVideo');
  const btnSnap        = document.getElementById('btnSnap');
  const btnSwitchCam   = document.getElementById('btnSwitchCam');
  const camStatus      = document.getElementById('camStatus');

  /* State variables */
  let sourceFile  = null;
  let sourceImg   = new Image();
  let sourceObjectUrl = null;
  let correctedCanvas = document.createElement('canvas');
  let correctedReady  = false;
  let imageState  = 'idle';  // idle | loading | ready | error
  let map         = null;
  let mapMarker   = null;
  let addressText = '';
  let camStream   = null;
  let facingMode  = 'environment';

  /* Helper functions */
  const pad2 = (n) => String(n).padStart(2,'0');
  const clamp = (v,min,max) => Math.max(min, Math.min(max, v));
  const toNumberOrNull = (v) => {
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  };
  const hasValidLatLng = () => {
    const lat = toNumberOrNull(latEl.value);
    const lng = toNumberOrNull(lngEl.value);
    if (lat === null || lng === null) return false;
    return (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180);
  };

  function setImageUIState(state, extraText='') {
    imageState = state;
    imgSpinner.style.display = (state === 'loading') ? 'inline-block' : 'none';

    if (state === 'idle') {
      imgBadge.className = 'badge wait';
      imgBadge.textContent = '‚è≥ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ';
      imgHint.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‚Äù';
      imgStatus.textContent = extraText || '-';
      btnPreview.disabled = true;
      btnDownload.disabled = true;
      return;
    }
    if (state === 'loading') {
      imgBadge.className = 'badge wait';
      imgBadge.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û...';
      imgHint.textContent = '‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‚Ä¶ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏õ‡∏∏‡πà‡∏°‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏à‡∏∞‡∏Å‡∏î‡πÑ‡∏î‡πâ';
      imgStatus.textContent = extraText || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏π‡∏õ‚Ä¶';
      btnPreview.disabled = true;
      btnDownload.disabled = true;
      return;
    }
    if (state === 'ready') {
      imgBadge.className = 'badge ok';
      imgBadge.textContent = '‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
      imgHint.textContent  = '‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡∏î ‚Äú‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‚Äù ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢';
      imgStatus.textContent= extraText || imgStatus.textContent;
      btnPreview.disabled = false;
      btnDownload.disabled= true;
      return;
    }
    if (state === 'error') {
      imgBadge.className = 'badge err';
      imgBadge.textContent = '‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      imgHint.textContent  = '‡∏•‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
      imgStatus.textContent= extraText || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
      btnPreview.disabled = true;
      btnDownload.disabled= true;
      return;
    }
  }

  function getSelectedDate() {
    if (useNow.checked) return new Date();
    const v = customTime.value;
    if (!v) return null;
    return new Date(v);
  }

  function formatThaiDate(date) {
    const d  = date.getDate();
    const m  = date.toLocaleString('th-TH',{ month:'short' });
    const y  = date.getFullYear();
    const hh = date.getHours();
    const mm = date.getMinutes();
    const ss = date.getSeconds();
    const tz = 'GMT+07:00';
    return `${d} ${m}. ${y} ${hh} ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤ ${mm} ‡∏ô‡∏≤‡∏ó‡∏µ ${ss} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ${tz}`;
  }

  function buildFilename(date) {
    const yyyy = date.getFullYear();
    const MM   = pad2(date.getMonth()+1);
    const dd   = pad2(date.getDate());
    const HH   = pad2(date.getHours());
    const mm   = pad2(date.getMinutes());
    const ss   = pad2(date.getSeconds());
    return `PT_${yyyy}${MM}${dd}_${HH}${mm}${ss}.jpg`;
  }

  function setTimeUIStatus() {
    const d = getSelectedDate();
    if (!d) {
      timeStatus.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤ (datetime-local)';
      return;
    }
    timeStatus.textContent = `‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ: ${formatThaiDate(d)}`;
  }

  function updateOutputUI() {
    const mode = outputMode.value;
    fitMode.disabled = (mode !== 'fixed');
    if (mode === 'original') {
      outStatus.textContent = 'Output = ‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏¥‡∏° (‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á) ‚Ä¢ ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö 1920√ó1440';
    } else {
      outStatus.textContent =
        `Output = 1920√ó1440 ‚Ä¢ Fit = ${fitMode.value === 'contain' ? 'Contain (‡∏Ç‡∏≠‡∏ö‡∏î‡∏≥)' : 'Cover (‡∏Ñ‡∏£‡∏≠‡∏õ‡πÄ‡∏ï‡πá‡∏°‡πÄ‡∏ü‡∏£‡∏°)'}`;
    }
  }

  function updateFontUI() {
    const auto = fontAuto.checked;
    fontScale.disabled = !auto;
    fontPx.disabled    = auto;
  }

  async function reverseGeocode(lat, lng) {
    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lng)}&zoom=18&addressdetails=1`;
    const res = await fetch(url, {
      headers: {
        'Accept': 'application/json',
        'Accept-Language': 'th-TH,th;q=0.9,en;q=0.7'
      }
    });
    if (!res.ok) throw new Error('Reverse geocode failed');
    const data = await res.json();
    return data?.display_name || '';
  }

  async function forwardGeocode(q) {
    const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(q)}&limit=1`;
    const res = await fetch(url, {
      headers: {
        'Accept': 'application/json',
        'Accept-Language': 'th-TH,th;q=0.9,en;q=0.7'
      }
    });
    if (!res.ok) throw new Error('Search place failed');
    const data = await res.json();
    if (!Array.isArray(data) || data.length === 0) return null;
    return {
      lat: Number(data[0].lat),
      lng: Number(data[0].lon),
      display_name: data[0].display_name || ''
    };
  }

  async function refreshAddressIfNeeded() {
    addressText = '';
    if (!enableLocation.checked) {
      locStatus.textContent = '‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á';
      return;
    }
    if (!hasValidLatLng()) {
      locStatus.textContent = '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Lat/Lng ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
      return;
    }
    const lat = Number(latEl.value);
    const lng = Number(lngEl.value);
    let msg  = `Lat/Lng: ${lat.toFixed(6)}, ${lng.toFixed(6)}\n`;
    if (showAddress.checked) {
      locStatus.textContent = msg + '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏≤‡∏Å Nominatim...';
      try {
        addressText = await reverseGeocode(lat, lng);
        msg += `Address: ${addressText || '(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà)'}`;
      } catch {
        msg += 'Address: (‡∏î‡∏∂‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚Äî ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô https)';
      }
    } else {
      msg += 'Address: (‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà)';
    }
    locStatus.textContent = msg;
  }

  async function fixOrientation(file, imgEl) {
    correctedReady = false;
    let orientation = 1;
    try {
      const buf = await file.arrayBuffer();
      const tags = ExifReader.load(buf, { expanded:true });
      const o    = tags?.exif?.Orientation?.value;
      if (Array.isArray(o)) orientation = o[0] ?? 1;
      else if (typeof o === 'number') orientation = o;
    } catch {
      orientation = 1;
    }

    const w  = imgEl.naturalWidth;
    const h  = imgEl.naturalHeight;
    const c  = correctedCanvas;
    const cctx = c.getContext('2d');

    if ([5,6,7,8].includes(orientation)) {
      c.width = h; c.height = w;
    } else {
      c.width = w; c.height = h;
    }

    cctx.save();
    switch (orientation) {
      case 2: cctx.translate(w,0); cctx.scale(-1,1); break;
      case 3: cctx.translate(w,h); cctx.rotate(Math.PI); break;
      case 4: cctx.translate(0,h); cctx.scale(1,-1); break;
      case 5: cctx.rotate(0.5*Math.PI); cctx.scale(1,-1); break;
      case 6: cctx.translate(h,0); cctx.rotate(0.5*Math.PI); break;
      case 7: cctx.translate(h,0); cctx.rotate(0.5*Math.PI); cctx.scale(-1,1); break;
      case 8: cctx.translate(0,w); cctx.rotate(-0.5*Math.PI); break;
    }
    cctx.drawImage(imgEl, 0, 0);
    cctx.restore();
    correctedReady = true;
  }

  /* Clean up old object URL */
  function revokeObjectUrl() {
    if (sourceObjectUrl) {
      URL.revokeObjectURL(sourceObjectUrl);
      sourceObjectUrl = null;
    }
  }

  async function loadFile(file, { fromCamera=false } = {}) {
    sourceFile = file;
    correctedReady = false;
    btnDownload.disabled = true;
    renderStatus.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ render';
    setImageUIState('loading', `‡πÑ‡∏ü‡∏•‡πå: ${fromCamera ? '(Camera)' : (file.name || 'unknown')}`);
    revokeObjectUrl();

    sourceObjectUrl = URL.createObjectURL(file);
    sourceImg = new Image();
    sourceImg.onload = async () => {
      try {
        const w = sourceImg.naturalWidth;
        const h = sourceImg.naturalHeight;
        let info = `‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß: ${fromCamera ? '(Camera)' : file.name}\n‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏î‡∏¥‡∏°: ${w}√ó${h}`;

        if (!fromCamera) {
          info += '\n‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ orientation...';
          imgStatus.textContent = info;
          await fixOrientation(file, sourceImg);
          info += `\n(‡πÅ‡∏Å‡πâ orientation ‡πÅ‡∏•‡πâ‡∏ß: ${correctedCanvas.width}√ó${correctedCanvas.height})`;
        } else {
          correctedCanvas.width = w;
          correctedCanvas.height= h;
          correctedCanvas.getContext('2d').drawImage(sourceImg, 0, 0);
          correctedReady = true;
          info += `\n(‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á: ${correctedCanvas.width}√ó${correctedCanvas.height})`;
        }
        setImageUIState('ready', info);
      } catch (e) {
        setImageUIState('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏π‡∏õ: ' + (e?.message || 'unknown'));
      }
    };
    sourceImg.onerror = () => {
      setImageUIState('error', '‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏≤‡∏à‡πÄ‡∏™‡∏µ‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ö‡∏•‡πá‡∏≠‡∏Å)');
    };
    sourceImg.src = sourceObjectUrl;
  }

  /* Draw helper: contain & cover */
  function drawContain(src, outW, outH) {
    ctx.clearRect(0, 0, outW, outH);
    ctx.fillStyle = '#000';
    ctx.fillRect(0,0,outW,outH);
    const sw = src.width;
    const sh = src.height;
    const scale = Math.min(outW / sw, outH / sh);
    const dw = Math.round(sw * scale);
    const dh = Math.round(sh * scale);
    const dx = Math.round((outW - dw) / 2);
    const dy = Math.round((outH - dh) / 2);
    ctx.drawImage(src, 0, 0, sw, sh, dx, dy, dw, dh);
  }

  function drawCover(src, outW, outH) {
    ctx.clearRect(0, 0, outW, outH);
    ctx.fillStyle = '#000';
    ctx.fillRect(0,0,outW,outH);
    const sw = src.width;
    const sh = src.height;
    const scale = Math.max(outW / sw, outH / sh);
    const dw = Math.round(sw * scale);
    const dh = Math.round(sh * scale);
    const dx = Math.round((outW - dw) / 2);
    const dy = Math.round((outH - dh) / 2);
    ctx.drawImage(src, 0, 0, sw, sh, dx, dy, dw, dh);
  }

  function computeFontSizePx(outW, outH) {
    if (!fontAuto.checked) {
      const px = Number(fontPx.value);
      return clamp(Number.isFinite(px) ? px : 32, 10, 200);
    }
    const base = Math.min(outW, outH);
    const autoPx = clamp(Math.round(base * 0.022), 12, 200);
    const scalePct = clamp(Number(fontScale.value) || 100, 50, 250);
    return clamp(Math.round(autoPx * (scalePct / 100)), 10, 200);
  }

  function drawOverlayText(lines, outW, outH) {
    const fontSize = computeFontSizePx(outW, outH);
    const padding = Math.round(Math.min(outW, outH) * 0.018);
    const lineGap = Math.round(fontSize * 1.15);
    ctx.save();
    ctx.textAlign   = 'right';
    ctx.textBaseline= 'top';
    ctx.font        = `800 ${fontSize}px system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans Thai", sans-serif`;
    ctx.fillStyle   = 'white';
    ctx.shadowColor = 'rgba(0,0,0,.85)';
    ctx.shadowBlur  = Math.round(fontSize * 0.35);
    ctx.shadowOffsetX=0;
    ctx.shadowOffsetY=0;
    const x = outW - padding;
    let y = padding;
    for (const line of lines) {
      ctx.fillText(line, x, y);
      y += lineGap;
    }
    ctx.restore();
  }

  function buildOverlayLines(date) {
    const lines = [];
    lines.push(`Network: ${formatThaiDate(date)}`);
    lines.push(`Local:   ${formatThaiDate(date)}`);
    if (enableLocation.checked && hasValidLatLng()) {
      const lat = Number(latEl.value);
      const lng = Number(lngEl.value);
      if (showLatLng.checked) lines.push(`üìç ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
      if (showAddress.checked) lines.push(addressText || '(‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°)');
    }
    return lines;
  }

  async function render() {
    btnDownload.disabled = true;
    if (!sourceFile || !sourceImg?.src) {
      renderStatus.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ/‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô';
      return;
    }
    if (imageState !== 'ready' || !correctedReady) {
      renderStatus.textContent = '‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î/‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‚Ä¶ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
      return;
    }
    const d = getSelectedDate();
    if (!d) {
      renderStatus.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤';
      return;
    }
    const src = correctedCanvas;
    const sw  = src.width;
    const sh  = src.height;
    const mode = outputMode.value;
    let outW, outH;
    if (mode === 'original') {
      outW = sw;
      outH = sh;
    } else {
      outW = DEFAULT_W;
      outH = DEFAULT_H;
    }
    canvas.width = outW;
    canvas.height= outH;
    if (mode === 'original') {
      ctx.clearRect(0,0,outW,outH);
      ctx.drawImage(src, 0,0, sw, sh, 0,0, outW, outH);
    } else {
      if (fitMode.value === 'cover') drawCover(src, outW, outH);
      else drawContain(src, outW, outH);
    }
    if (enableLocation.checked && hasValidLatLng() && showAddress.checked && !addressText) {
      try {
        addressText = await reverseGeocode(Number(latEl.value), Number(lngEl.value));
      } catch {
        // ignore
      }
    }
    const lines = buildOverlayLines(d);
    drawOverlayText(lines, outW, outH);
    renderStatus.textContent =
      `‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß\nOutput: ${outW}√ó${outH} ‚Ä¢ ${mode === 'fixed' ? (fitMode.value === 'cover' ? 'Cover(crop)' : 'Contain') : 'Original size'}\nFont: ${computeFontSizePx(outW, outH)}px ‚Ä¢ Overlay: ${lines.length} ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î`;
    btnDownload.disabled = false;
  }

  function download() {
    const d = getSelectedDate();
    if (!d) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤'); return; }
    if (imageState !== 'ready') { alert('‡∏†‡∏≤‡∏û‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‚Äù ‡∏Å‡πà‡∏≠‡∏ô'); return; }
    const name = buildFilename(d);
    const link = document.createElement('a');
    link.download = name;
    link.href = canvas.toDataURL('image/jpeg', 0.95);
    link.click();
  }

  /* Time UI events */
  useNow.addEventListener('change', setTimeUIStatus);
  customTime.addEventListener('input', setTimeUIStatus);
  btnSetNow.addEventListener('click', () => {
    const now = new Date();
    const v = `${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())}T${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
    customTime.value = v;
    useNow.checked  = true;
    setTimeUIStatus();
  });
  setTimeUIStatus();

  /* Output UI events */
  outputMode.addEventListener('change', updateOutputUI);
  fitMode.addEventListener('change', updateOutputUI);
  fontAuto.addEventListener('change', updateFontUI);
  updateOutputUI();
  updateFontUI();

  /* Location events */
  enableLocation.addEventListener('change', refreshAddressIfNeeded);
  showLatLng.addEventListener('change', refreshAddressIfNeeded);
  showAddress.addEventListener('change', refreshAddressIfNeeded);
  latEl.addEventListener('input', () => { addressText=''; refreshAddressIfNeeded(); });
  lngEl.addEventListener('input', () => { addressText=''; refreshAddressIfNeeded(); });

  btnUseGPS.addEventListener('click', async () => {
    if (!enableLocation.checked) enableLocation.checked = true;
    if (!navigator.geolocation) {
      locStatus.textContent = '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå/‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS';
      return;
    }
    locStatus.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å GPS...';
    navigator.geolocation.getCurrentPosition(async (pos) => {
      latEl.value = pos.coords.latitude;
      lngEl.value = pos.coords.longitude;
      addressText = '';
      await refreshAddressIfNeeded();
    }, (err) => {
      locStatus.textContent = '‡∏Ç‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ' + (err?.message || 'unknown error') + '\\n(‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô https ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï location)';
    }, { enableHighAccuracy:true, timeout:12000, maximumAge:0 });
  });

  btnSearchPlace.addEventListener('click', async () => {
    const q = placeQuery.value.trim();
    if (!q) return;
    if (!enableLocation.checked) enableLocation.checked = true;
    locStatus.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà...';
    try {
      const r = await forwardGeocode(q);
      if (!r) { locStatus.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà'; return; }
      latEl.value = r.lat;
      lngEl.value = r.lng;
      addressText = r.display_name || '';
      await refreshAddressIfNeeded();
      if (map) {
        map.setView([r.lat, r.lng], 17);
        if (!mapMarker) mapMarker = L.marker([r.lat, r.lng]).addTo(map);
        mapMarker.setLatLng([r.lat, r.lng]);
      }
    } catch {
      locStatus.textContent = '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô https ‡πÅ‡∏•‡∏∞‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ)';
    }
  });

  /* Map picker */
  function openMap() {
    mapWrap.style.display = 'block';
    const lat = hasValidLatLng() ? Number(latEl.value) : 13.7563;
    const lng = hasValidLatLng() ? Number(lngEl.value) : 100.5018;
    if (!map) {
      map = L.map('map', { zoomControl:true }).setView([lat, lng], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom:19, attribution:'&copy; OpenStreetMap'
      }).addTo(map);
      mapMarker = L.marker([lat, lng]).addTo(map);
      map.on('click', async (e) => {
        latEl.value = e.latlng.lat;
        lngEl.value = e.latlng.lng;
        mapMarker.setLatLng(e.latlng);
        addressText = '';
        if (!enableLocation.checked) enableLocation.checked = true;
        await refreshAddressIfNeeded();
      });
    } else {
      map.setView([lat, lng], 15);
      if (mapMarker) mapMarker.setLatLng([lat, lng]);
    }
    setTimeout(() => map.invalidateSize(), 60);
  }
  function closeMap() { mapWrap.style.display = 'none'; }
  btnPickOnMap.addEventListener('click', () => {
    if (!enableLocation.checked) enableLocation.checked = true;
    openMap();
  });
  btnConfirmMap.addEventListener('click', async () => {
    if (!hasValidLatLng()) { locStatus.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'; return; }
    closeMap();
    await refreshAddressIfNeeded();
  });
  btnCloseMap.addEventListener('click', closeMap);

  /* Camera functions */
  function showCamModal(on) {
    camBackdrop.style.display = on ? 'flex' : 'none';
    camBackdrop.setAttribute('aria-hidden', on ? 'false' : 'true');
  }
  async function stopCamera() {
    if (camStream) {
      camStream.getTracks().forEach(t => t.stop());
      camStream = null;
    }
    camVideo.srcObject = null;
  }
  async function startCamera() {
    camStatus.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á...';
    try {
      if (!navigator.mediaDevices?.getUserMedia) {
        camStatus.textContent = '‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á';
        return;
      }
      await stopCamera();
      const constraints = {
        video: {
          facingMode: { ideal: facingMode },
          width: { ideal: 1920 },
          height:{ ideal: 1080 }
        },
        audio: false
      };
      camStream = await navigator.mediaDevices.getUserMedia(constraints);
      camVideo.srcObject = camStream;
      camStatus.textContent = `‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß (${facingMode === 'environment' ? '‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á' : '‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤'})`;
    } catch (e) {
      camStatus.textContent = '‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (e?.message || 'unknown error') + '\\n(‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô https ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏•‡πâ‡∏≠‡∏á)';
    }
  }
  function snapPhoto() {
    if (!camStream) {
      camStatus.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏•‡πâ‡∏≠‡∏á';
      return;
    }
    const vw = camVideo.videoWidth || 1280;
    const vh = camVideo.videoHeight || 720;
    const c  = document.createElement('canvas');
    c.width  = vw;
    c.height = vh;
    const cctx = c.getContext('2d');
    cctx.drawImage(camVideo, 0, 0, vw, vh);
    c.toBlob(async (blob) => {
      if (!blob) {
        camStatus.textContent = '‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
        return;
      }
      const file = new File([blob], 'camera.jpg', { type:'image/jpeg' });
      await loadFile(file, { fromCamera:true });
      camStatus.textContent = '‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡πÅ‡∏•‡πâ‡∏ß ‚úÖ';
      showCamModal(false);
      await stopCamera();
    }, 'image/jpeg', 0.95);
  }
  btnOpenCamera.addEventListener('click', async () => {
    showCamModal(true);
    await startCamera();
  });
  btnCloseCamera.addEventListener('click', async () => {
    showCamModal(false);
    await stopCamera();
  });
  btnSwitchCam.addEventListener('click', async () => {
    facingMode = (facingMode === 'environment') ? 'user' : 'environment';
    await startCamera();
  });
  btnSnap.addEventListener('click', snapPhoto);

  /* File input event */
  fileGallery.addEventListener('change', (e) => {
    const f = e.target.files?.[0];
    if (f) loadFile(f, { fromCamera:false });
  });

  /* Preview & Download events */
  btnPreview.addEventListener('click', render);
  btnDownload.addEventListener('click', download);

  /* Initialize UI */
  setImageUIState('idle');
  locStatus.textContent = '‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á';

  /* Cleanup on unload */
  window.addEventListener('beforeunload', () => {
    revokeObjectUrl();
    stopCamera();
  });
})();
</script>
</body>
</html>
